{# support_dashboard/templates/support_dashboard/request_detail.html #}
{% extends 'sfrp/sfrp_base.html' %}
{% load dashboard_extras %} {# Load your custom template tag if you created it #}

{% block title %}Request #{{ request_obj.pk }} - Support Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    {% include 'support_dashboard/_breadcrumbs.html' %}
    <h2 class="mb-4">Request #{{ request_obj.pk }} ({{ request_type|title }})</h2>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            Request Details
        </div>
        <div class="card-body">
            <div class="row mb-2">
                <div class="col-md-4"><strong>Subject:</strong></div>
                <div class="col-md-8">{{ request_obj.subject }}</div>
            </div>
            <div class="row mb-2">
                <div class="col-md-4"><strong>Status:</strong></div>
                <div class="col-md-8"><span class="badge badge-{% if request_obj.status == 'new' %}primary{% elif request_obj.status == 'in_progress' %}info{% elif request_obj.status == 'resolved' %}success{% elif request_obj.status == 'closed' %}secondary{% elif request_obj.status == 'rejected' %}danger{% endif %}">{{ request_obj.get_status_display }}</span></div>
            </div>
            <div class="row mb-2">
                <div class="col-md-4"><strong>Assigned To:</strong></div>
                <div class="col-md-8">
                    {% if request_obj.assigned_to %}
                        {{ request_obj.assigned_to.get_full_name|default:request_obj.assigned_to.username }}
                    {% else %}
                        Unassigned
                    {% endif %}
                </div>
            </div>
            <hr>
            <div class="row mb-2">
                <div class="col-md-4"><strong>Submitted By:</strong></div>
                <div class="col-md-8">
                    {% if request_obj.submitted_by %}
                        {{ request_obj.submitted_by.get_full_name|default:request_obj.submitted_by.username }}
                    {% else %}
                        Anonymous
                    {% endif %}
                </div>
            </div>
            {% if request_obj.submitted_by == None %} {# Check if anonymous submission #}
            <div class="row mb-2">
                <div class="col-md-4"><strong>Anonymous Name:</strong></div>
                <div class="col-md-8">{{ request_obj.full_name|default:"N/A" }}</div>
            </div>
            <div class="row mb-2">
                <div class="col-md-4"><strong>Anonymous Email:</strong></div>
                <div class="col-md-8">{{ request_obj.email|default:"N/A" }}</div>
            </div>
            <div class="row mb-2">
                <div class="col-md-4"><strong>Anonymous Phone:</strong></div>
                <div class="col-md-8">{{ request_obj.phone_number|default:"N/A" }}</div>
            </div>
            {% endif %}
            <div class="row mb-2">
                <div class="col-md-4"><strong>Submitted At:</strong></div>
                <div class="col-md-8">{{ request_obj.submitted_at|date:"M d, Y H:i" }}</div>
            </div>
            <div class="row mb-2">
                <div class="col-md-4"><strong>Last Updated:</strong></div>
                <div class="col-md-8">{{ request_obj.updated_at|date:"M d, Y H:i" }}</div>
            </div>
            <hr>

            {# Display specific fields based on request type #}
            {% if request_obj|instance_of:'Complaint' %}
                <div class="row mb-2">
                    <div class="col-md-4"><strong>Complaint Category:</strong></div>
                    <div class="col-md-8">{{ request_obj.category.name }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4"><strong>Priority:</strong></div>
                    <div class="col-md-8">{{ request_obj.priority }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4"><strong>Location Address:</strong></div>
                    <div class="col-md-8">{{ request_obj.location_address|default:"N/A" }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4"><strong>Coordinates:</strong></div>
                    <div class="col-md-8">{% if request_obj.latitude and request_obj.longitude %}{{ request_obj.latitude }}, {{ request_obj.longitude }}{% else %}N/A{% endif %}</div>
                </div>

            {% elif request_obj|instance_of:'ServiceRequest' %}
                <div class="row mb-2">
                    <div class="col-md-4"><strong>Service Type:</strong></div>
                    <div class="col-md-8">{{ request_obj.service_type.name }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4"><strong>Priority:</strong></div>
                    <div class="col-md-8">{{ request_obj.priority|default:"N/A" }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4"><strong>Due Date:</strong></div>
                    <div class="col-md-8">{{ request_obj.due_date|date:"M d, Y"|default:"N/A" }}</div>
                </div>

            {% elif request_obj|instance_of:'Inquiry' %}
                <div class="row mb-2">
                    <div class="col-md-4"><strong>Inquiry Category:</strong></div>
                    <div class="col-md-8">{{ request_obj.inquiry.name }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4"><strong>Quesion:</strong></div>
                    <div class="col-md-8">{{ request_obj.question }}</div>
                </div>

            {% elif request_obj|instance_of:'EmergencyReport' %}
                <div class="row mb-2">
                    <div class="col-md-4"><strong>Emergency Type:</strong></div>
                    <div class="col-md-8">{{ request_obj.emergency_type.name }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-4"><strong>Specific Location:</strong></div>
                    <div class="col-md-8">{{ request_obj.location }}</div>
                </div>
            {% endif %}

            <div class="row mb-2">
                <div class="col-md-4"><strong>Description:</strong></div>
                <div class="col-md-8">{{ request_obj.description }}</div>
            </div>
        </div>
    </div>

    {# Attachments Section #}
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            Attachments
        </div>
        <div class="card-body">
            {% if attachments %}
                <ul class="list-group list-group-flush">
                    {% for attachment in attachments %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <i class="fa fa-paperclip mr-2"></i> {{ attachment.file.name|split_filename }}
                            </span>
                            <a href="{{ attachment.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fa fa-download mr-1"></i> View/Download
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">No attachments for this request.</p>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            Update Request
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <div class="form-group row">
                    <label for="{{ status_form.status.id_for_label }}" class="col-sm-2 col-form-label">Status:</label>
                    <div class="col-sm-6">
                        {{ status_form.status }}
                    </div>
                    <div class="col-sm-4">
                        <button type="submit" name="update_status" class="btn btn-sm btn-primary">Update Status</button>
                    </div>
                </div>
                {% if status_form.status.errors %}
                    <div class="text-danger offset-sm-2 col-sm-10">
                        {{ status_form.status.errors }}
                    </div>
                {% endif %}
            </form>

            <form method="post" class="mt-3">
                {% csrf_token %}
                <div class="form-group row">
                    <label for="{{ assignment_form.assigned_to.id_for_label }}" class="col-sm-2 col-form-label">Assign To:</label>
                    <div class="col-sm-6">
                        {{ assignment_form.assigned_to }}
                    </div>
                    <div class="col-sm-4">
                        <button type="submit" name="update_assignment" class="btn btn-sm btn-info">Update Assignment</button>
                    </div>
                </div>
                {% if assignment_form.assigned_to.errors %}<div class="text-danger offset-sm-2 col-sm-10">{{ assignment_form.assigned_to.errors }}</div>{% endif %}
            </form>
        </div>
    </div>

    <a href="{% url 'support_dashboard:request_list' %}" class="btn btn-secondary">Back to List</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Optional JS for enhancing forms
</script>
{% endblock %}
