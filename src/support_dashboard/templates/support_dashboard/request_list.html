{% extends 'sfrp/sfrp_base.html' %}
{% load static %}
{% load i18n %}
{% load dashboard_extras %} {# Ensure this loads your custom filters #}

{% block title %}
    {% trans "Support Dashboard" %}
{% endblock title %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        {# Sidebar Navigation for Support Dashboard #}
        <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
            <div class="position-sticky pt-3">
                <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                    <span>{% trans "Requests" %}</span>
                </h6>
                <ul class="nav flex-column mb-2">
                    <li class="nav-item">
                        <a href="{% url 'support_dashboard:request_list' %}" class="nav-link {% if request.resolver_match.view_name == 'support_dashboard:request_list' %} active {% endif %}">
                            <i class="fas fa-list-alt mr-2"></i> {% trans "All Requests" %}
                        </a>
                    </li>
                    {# Add more specific request type links if desired, similar to user dashboard #}
                </ul>

                <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                    <span>{% trans "Management" %}</span>
                </h6>
                <ul class="nav flex-column mb-2">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'support_dashboard:faq_item_list' %}">
                            <i class="fas fa-question-circle mr-2"></i> {% trans "Manage FAQs" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'support_dashboard:category_list' category_type_slug='complaint' %}">
                            <i class="fas fa-tags mr-2"></i> {% trans "Manage Categories" %}
                        </a>
                    </li>
                    {% if request.user.is_superuser %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'support_dashboard:user_list' %}">
                            <i class="fas fa-users-cog mr-2"></i> {% trans "Manage Users" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'support_dashboard:group_list' %}">
                            <i class="fas fa-user-friends mr-2"></i> {% trans "Manage Groups" %}
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </nav>
        
        {# Main Content #}
        <main class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
            {% include 'support_dashboard/_breadcrumbs.html' %}
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">{% trans "Support Dashboard" %}</h1>
            </div>

            {# Dashboard Statistics Cards #}
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <h5 class="card-title">{% trans "Total Requests" %}</h5>
                            <p class="card-text h3">{{ dashboard_stats.total_requests }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success mb-3">
                        <div class="card-body">
                            <h5 class="card-title">{% trans "Resolved Today" %}</h5>
                            <p class="card-text h3">{{ dashboard_stats.resolved_today }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info mb-3">
                        <div class="card-body">
                            <h5 class="card-title">{% trans "New Today" %}</h5>
                            <p class="card-text h3">{{ dashboard_stats.new_today }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning mb-3">
                        <div class="card-body">
                            <h5 class="card-title">{% trans "Open Requests" %}</h5>
                            <p class="card-text h3">{{ dashboard_stats.status_counts.new|default:0 }}</p> {# Assuming 'new' status means open #}
                        </div>
                    </div>
                </div>
            </div>

            {# Charts Section: Trend, Status Pie, Type Bar #}
            <div class="row mb-4">
                {# Trend Chart Column #}
                <div class="col-md-12 mb-4"> {# This will take full width, as trend chart is usually larger #}
                    <div class="card shadow-sm">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">{% trans "Request Trend Analysis" %}</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-center mb-4">
                                <button id="dailyBtn" class="btn btn-primary me-2">{% trans "Daily" %}</button>
                                <button id="weeklyBtn" class="btn btn-secondary me-2">{% trans "Weekly" %}</button>
                                <button id="monthlyBtn" class="btn btn-secondary me-2">{% trans "Monthly" %}</button>
                                <button id="yearlyBtn" class="btn btn-secondary">{% trans "Yearly" %}</button>
                            </div>
                            <div class="position-relative" style="height: 400px;">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                {# Status Pie Chart Column #}
                <div class="col-md-6 mb-4"> {# Half width on medium/large screens #}
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">{% trans "Requests by Status" %}</h5>
                        </div>
                        <div class="card-body d-flex justify-content-center align-items-center">
                            <div class="position-relative" style="height: 300px; width: 300px;"> {# Fixed size for pie chart #}
                                <canvas id="statusPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                {# Type Bar Chart Column #}
                <div class="col-md-6 mb-4"> {# Half width on medium/large screens #}
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">{% trans "Requests by Type" %}</h5>
                        </div>
                        <div class="card-body d-flex justify-content-center align-items-center">
                            <div class="position-relative" style="height: 300px; width: 100%;"> {# Full width for bar chart #}
                                <canvas id="typeBarChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            {# Request Filter Form #}
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">{% trans "Filter Requests" %}</h5>
                </div>
                <div class="card-body">
                    <form method="get" class="form-row align-items-end">
                        <div class="col-md-3 mb-3">
                            <label for="{{ filter_form.request_type.id_for_label }}">{% trans "Type" %}</label>
                            {{ filter_form.request_type }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ filter_form.status.id_for_label }}">{% trans "Status" %}</label>
                            {{ filter_form.status }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ filter_form.assigned_to.id_for_label }}">{% trans "Assigned To" %}</label>
                            {{ filter_form.assigned_to }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ filter_form.q.id_for_label }}">{% trans "Search" %}</label>
                            {{ filter_form.q }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ filter_form.submitted_after.id_for_label }}">{% trans "Submitted After" %}</label>
                            {{ filter_form.submitted_after }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ filter_form.submitted_before.id_for_label }}">{% trans "Submitted Before" %}</label>
                            {{ filter_form.submitted_before }}
                        </div>
                        <div class="col-md-3 mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="{{ filter_form.show_unassigned.id_for_label }}" name="{{ filter_form.show_unassigned.name }}" {% if filter_form.show_unassigned.value %}checked{% endif %}>
                            <label class="form-check-label" for="{{ filter_form.show_unassigned.id_for_label }}">{% trans "Show Unassigned" %}</label>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button type="submit" class="btn btn-primary">{% trans "Apply Filter" %}</button>
                            <a href="{% url 'support_dashboard:request_list' %}" class="btn btn-outline-secondary ml-2">{% trans "Clear Filter" %}</a>
                        </div>
                    </form>
                </div>
            </div>

            {# Request List Table #}
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">{% trans "All Requests" %}</h5>
                </div>
                <div class="card-body">
                    {% if requests %}
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>{% trans "ID" %}</th>
                                    <th>{% trans "Type" %}</th>
                                    <th>{% trans "Subject" %}</th>
                                    <th>{% trans "Status" %}</th>
                                    <th>{% trans "Assigned To" %}</th>
                                    <th>{% trans "Submitted At" %}</th>
                                    <th>{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for request_obj in requests %}
                                <tr>
                                    <td>{{ request_obj.pk }}</td>
                                    <td>{{ request_obj.request_type_slug|title|replace:"_, " }}</td> 
                                    <td>{{ request_obj.subject }}</td>
                                    <td>
                                        <span class="badge badge-{% if request_obj.status == 'new' %}primary{% elif request_obj.status == 'in_progress' %}info{% elif request_obj.status == 'resolved' %}success{% elif request_obj.status == 'closed' %}secondary{% elif request_obj.status == 'rejected' %}danger{% else %}light{% endif %}">
                                            {{ request_obj.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if request_obj.assigned_to %}
                                            {{ request_obj.assigned_to.get_full_name|default:request_obj.assigned_to.username }}
                                        {% else %}
                                            <span class="text-muted">{% trans "Unassigned" %}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ request_obj.submitted_at|date:"M d, Y H:i" }}</td>
                                    <td>
                                        <a href="{% url 'support_dashboard:request_detail' request_type=request_obj.request_type_slug pk=request_obj.pk %}" class="btn btn-sm btn-outline-primary">
                                            {% trans "View" %}
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                        <p class="text-center">{% trans "No requests found matching your criteria." %}</p>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    {# Luxon for date manipulation - LOADED FIRST #}
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    {# Chart.js CDN #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    {# Chart.js Adapter Luxon for time scales - LOADED AFTER LUXON AND CHART.JS #}
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.1.0/dist/chartjs-adapter-luxon.min.js"></script>

    {# JSON script tags to pass data from Django to JavaScript #}
    {{ request_trend_data|json_script:"request_trend_data_json" }}
    {{ request_types_for_chart|json_script:"request_types_for_chart_json" }}
    {{ status_choices_for_chart|json_script:"status_choices_for_chart_json" }}
    {{ dashboard_stats|json_script:"dashboard_stats_json" }}

    <script>
        const DateTime = luxon.DateTime;

        // Get actual historical data from Django context
        const rawHistoricalData = JSON.parse(document.getElementById('request_trend_data_json').textContent);
        const typeLabelsMap = JSON.parse(document.getElementById('request_types_for_chart_json').textContent);
        const statusChoices = JSON.parse(document.getElementById('status_choices_for_chart_json').textContent);
        const dashboardStats = JSON.parse(document.getElementById('dashboard_stats_json').textContent);

        // --- DEBUGGING LOGS ---
        console.log("Dashboard Stats:", dashboardStats);
        console.log("Raw Historical Data (Trend):", rawHistoricalData);
        console.log("Request Types Map:", typeLabelsMap);
        console.log("Status Choices:", statusChoices);
        // --- END DEBUGGING LOGS ---

        let trendChart; // Variable to hold the Chart.js instance

        // Define consistent colors for various chart elements
        const chartColors = {
            // Trend Chart Specific
            'new': { background: 'rgba(153, 102, 255, 0.8)', border: 'rgba(153, 102, 255, 1)' }, // Purple
            'resolved': { background: 'rgba(0, 128, 0, 0.8)', border: 'rgba(0, 128, 0, 1)' }, // Dark Green

            // Type Specific (for trend and bar charts)
            'complaint': { background: 'rgba(255, 99, 132, 0.8)', border: 'rgba(255, 99, 132, 1)' }, // Red
            'service': { background: 'rgba(54, 162, 235, 0.8)', border: 'rgba(54, 162, 235, 1)' },  // Blue
            'inquiry': { background: 'rgba(255, 206, 86, 0.8)', border: 'rgba(255, 206, 86, 1)' },  // Yellow
            'emergency': { background: 'rgba(75, 192, 192, 0.8)', border: 'rgba(75, 192, 192, 1)' },// Green

            // Status Specific (for pie chart) - more pastel/distinct colors
            'new': '#66BB6A', // Light Green
            'in_progress': '#42A5F5', // Light Blue
            'resolved': '#26A69A', // Teal
            'closed': '#BDBDBD', // Grey
            'rejected': '#EF5350', // Red
            'on_hold': '#FFCA28', // Amber
        };

        /**
         * Processes raw historical data into a format suitable for Chart.js line chart.
         * Aggregates data by the specified time unit (daily, weekly, monthly, yearly).
         * @param {Array<Object>} data - The raw historical data (daily counts).
         * @param {string} unit - The time unit ('day', 'week', 'month', 'year').
         * @returns {Object} - An object containing labels and datasets.
         */
        function processTrendData(data, unit) {
            const aggregatedData = {}; 
            let displayFormat; 

            data.forEach(item => {
                const date = DateTime.fromISO(item.date);
                let key;

                if (unit === 'day') {
                    key = date.toISODate();
                    displayFormat = 'MMM dd'; 
                } else if (unit === 'week') {
                    const startOfWeek = date.startOf('week');
                    key = startOfWeek.toISODate(); 
                    displayFormat = 'MMM d, yyyy'; 
                } else if (unit === 'month') {
                    const startOfMonth = date.startOf('month');
                    key = startOfMonth.toISODate(); 
                    displayFormat = 'MMM yyyy'; 
                } else if (unit === 'year') {
                    const startOfYear = date.startOf('year');
                    key = startOfYear.toISODate(); 
                    displayFormat = 'yyyy'; 
                }

                if (!aggregatedData[key]) {
                    aggregatedData[key] = {
                        date: date, 
                        new: 0,
                        resolved: 0
                    };
                    for (const typeKey in typeLabelsMap) {
                        aggregatedData[key][typeKey] = 0;
                    }
                }

                aggregatedData[key].new += item.new || 0;
                aggregatedData[key].resolved += item.resolved || 0;
                
                for (const typeKey in typeLabelsMap) {
                    aggregatedData[key][typeKey] += item[typeKey] || 0;
                }
            });

            const sortedAggregatedData = Object.values(aggregatedData).sort((a, b) => a.date.toMillis() - b.date.toMillis());

            const datasets = [];

            // Add 'New Requests' dataset
            datasets.push({
                label: 'New Requests',
                data: sortedAggregatedData.map(item => ({ x: item.date.toMillis(), y: item.new })),
                borderColor: chartColors.new.border,
                backgroundColor: chartColors.new.background,
                tension: 0.3,
                fill: false,
                borderWidth: 2,
                pointRadius: 3,
                pointBackgroundColor: chartColors.new.border,
                pointBorderColor: '#fff',
                pointHoverRadius: 5
            });

            // Add 'Resolved Requests' dataset
            datasets.push({
                label: 'Resolved Requests',
                data: sortedAggregatedData.map(item => ({ x: item.date.toMillis(), y: item.resolved })),
                borderColor: chartColors.resolved.border,
                backgroundColor: chartColors.resolved.background,
                tension: 0.3,
                fill: false,
                borderWidth: 2,
                pointRadius: 3,
                pointBackgroundColor: chartColors.resolved.border,
                pointBorderColor: '#fff',
                pointHoverRadius: 5
            });

            // Add datasets for each specific request type
            for (const typeKey in typeLabelsMap) {
                datasets.push({
                    label: typeLabelsMap[typeKey],
                    data: sortedAggregatedData.map(item => ({ x: item.date.toMillis(), y: item[typeKey] })),
                    borderColor: chartColors[typeKey].border,
                    backgroundColor: chartColors[typeKey].background,
                    tension: 0.3,
                    fill: false,
                    borderWidth: 2,
                    pointRadius: 3,
                    pointBackgroundColor: chartColors[typeKey].border,
                    pointBorderColor: '#fff',
                    pointHoverRadius: 5
                });
            }

            return {
                datasets: datasets,
                timeUnit: unit,
                displayFormat: displayFormat
            };
        }

        /**
         * Renders or updates the line chart.
         * @param {string} unit - The time unit to display ('day', 'week', 'month', 'year').
         */
        function renderTrendChart(unit) {
            const chartData = processTrendData(rawHistoricalData, unit);
            const ctx = document.getElementById('trendChart').getContext('2d');

            if (trendChart) {
                trendChart.destroy(); 
            }

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: chartData.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14
                                },
                                usePointStyle: true, 
                            }
                        },
                        title: {
                            display: true,
                            text: `Requests Trend (${unit.charAt(0).toUpperCase() + unit.slice(1)}ly)`,
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            color: '#333'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    const dateMillis = tooltipItems[0].parsed.x;
                                    const dateTime = DateTime.fromMillis(dateMillis);
                                    if (unit === 'day') {
                                        return dateTime.toFormat('MMM dd, yyyy');
                                    } else if (unit === 'week') {
                                        return `Week of ${dateTime.toFormat('MMM dd, yyyy')}`;
                                    } else if (unit === 'month') {
                                        return dateTime.toFormat('MMM yyyy');
                                    } else if (unit === 'year') {
                                        return dateTime.toFormat('yyyy');
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: unit,
                                tooltipFormat: chartData.displayFormat, 
                                displayFormats: {
                                    day: 'MMM dd',
                                    week: 'MMM dd',
                                    month: 'MMM yyyy',
                                    year: 'yyyy'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                font: {
                                    size: 16
                                },
                                color: '#555'
                            },
                            ticks: {
                                autoSkip: true,
                                maxTicksLimit: 10,
                                source: 'auto', 
                                color: '#666',
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                display: false 
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Requests',
                                font: {
                                    size: 16
                                },
                                color: '#555'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                },
                                color: '#666',
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)' 
                            }
                        }
                    }
                }
            });
            updateButtonStyles(unit);
        }

        /**
         * Renders the Status Pie Chart.
         */
        function renderStatusPieChart() {
            const ctx = document.getElementById('statusPieChart').getContext('2d');
            const statusLabels = [];
            const statusCounts = [];
            const statusBackgroundColors = [];
            const statusBorderColors = [];

            // Populate labels and data based on dashboardStats and statusChoices
            statusChoices.forEach(([value, display]) => {
                const count = dashboardStats.status_counts[value] || 0;
                if (count > 0) { // Only show statuses that have requests
                    statusLabels.push(display);
                    statusCounts.push(count);
                    statusBackgroundColors.push(chartColors[value] || '#CCCCCC'); // Use defined colors or a default
                    statusBorderColors.push('#FFFFFF'); // White border for slices
                }
            });

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        data: statusCounts,
                        backgroundColor: statusBackgroundColors,
                        borderColor: statusBorderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        title: {
                            display: false, // Title is in card header
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Renders the Request Type Bar Chart.
         */
        function renderTypeBarChart() {
            const ctx = document.getElementById('typeBarChart').getContext('2d');
            const typeLabels = [];
            const typeCounts = [];
            const typeBackgroundColors = [];
            const typeBorderColors = [];

            // Populate labels and data based on dashboardStats and typeLabelsMap
            for (const typeSlug in typeLabelsMap) {
                const count = dashboardStats.type_counts[typeSlug] || 0;
                if (count > 0) { // Only show types that have requests
                    typeLabels.push(typeLabelsMap[typeSlug]);
                    typeCounts.push(count);
                    typeBackgroundColors.push(chartColors[typeSlug].background || '#CCCCCC');
                    typeBorderColors.push(chartColors[typeSlug].border || '#999999');
                }
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: typeLabels,
                    datasets: [{
                        label: 'Number of Requests',
                        data: typeCounts,
                        backgroundColor: typeBackgroundColors,
                        borderColor: typeBorderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // No legend needed for single dataset bar chart
                        },
                        title: {
                            display: false, // Title is in card header
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Request Type'
                            },
                            ticks: {
                                autoSkip: false, // Show all labels
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            },
                            ticks: {
                                precision: 0 // Ensure integer ticks
                            }
                        }
                    }
                }
            });
        }


        /**
         * Updates the styling of the time unit buttons based on the active unit.
         * Uses Bootstrap's `btn-primary` and `btn-secondary` classes.
         * @param {string} activeUnit - The currently active time unit ('day', 'week', 'month', 'year').
         */
        function updateButtonStyles(activeUnit) {
            const buttons = {
                'dailyBtn': 'day',
                'weeklyBtn': 'week',
                'monthlyBtn': 'month',
                'yearlyBtn': 'year'
            };
            for (const btnId in buttons) {
                const button = document.getElementById(btnId);
                if (buttons[btnId] === activeUnit) {
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-primary');
                } else {
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-secondary');
                }
            }
        }

        // Event Listeners for buttons for the Trend Chart
        document.getElementById('dailyBtn').addEventListener('click', () => renderTrendChart('day'));
        document.getElementById('weeklyBtn').addEventListener('click', () => renderTrendChart('week'));
        document.getElementById('monthlyBtn').addEventListener('click', () => renderTrendChart('month'));
        document.getElementById('yearlyBtn').addEventListener('click', () => renderTrendChart('year'));

        // Initial render on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderTrendChart('day'); // Default to daily view for trend chart
            renderStatusPieChart(); // Render status pie chart
            renderTypeBarChart();   // Render type bar chart
        });
    </script>
{% endblock %}