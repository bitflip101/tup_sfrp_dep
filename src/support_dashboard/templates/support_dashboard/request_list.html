{# support_dashboard/templates/support_dashboard/request_list.html #}
{% extends 'sfrp/sfrp_base.html' %}
{% load static %}
{% load dashboard_extras %} {# Make sure dashboard_extras.py is set up correctly with 'replace' filter #}

{% block title %}All Requests - Support Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    {# Include Breadcrumbs #}
    {% include 'support_dashboard/_breadcrumbs.html' %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Support Dashboard Overview</h2>
        <div> {# Wrap buttons in a div to keep them together #}
            {# Link to Category Management #}
            <a href="{% url 'support_dashboard:category_list' category_type_slug='complaint' %}" class="btn btn-outline-dark mr-2">
                <i class="fas fa-cogs mr-2"></i> Manage Categories
            </a>
            {# Link to FAQ Management #}
            <a href="{% url 'support_dashboard:faq_item_list' %}" class="btn btn-outline-dark mr-2">
                <i class="fas fa-question-circle mr-2"></i> Manage FAQs
            </a>
            {# Link to User Management (only if superuser) #}
            {% if request.user.is_superuser %}
            <a href="{% url 'support_dashboard:user_list' %}" class="btn btn-outline-dark">
                <i class="fas fa-users-cog mr-2"></i> Manage Users
            </a>
            {# Link to Group Management #}
            <a href="{% url 'support_dashboard:group_list' %}" class="btn btn-outline-dark">
                <i class="fas fa-users mr-2"></i> Manage Groups
            </a>
            {% endif %}
        </div>
    </div>

    {# --- Dashboard Statistics Section --- #}
    {# Row for the three stat cards #}
    <div class="row mb-4 d-flex"> {# 'd-flex' makes columns in this row equal height for h-100 cards #}
        {# Total Requests Card #}
        <div class="col-12 col-md-4 mb-3"> {# Full width on extra small/small, 3 cards per row on medium and up #}
            <div class="card text-white bg-primary shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-center align-items-center"> {# Center content vertically and horizontally #}
                    <h5 class="card-title text-center">Total Requests</h5>
                    <p class="card-text display-4 text-center">{{ dashboard_stats.total_requests }}</p>
                </div>
            </div>
        </div>
        {# New Today Card #}
        <div class="col-12 col-md-4 mb-3"> {# Full width on extra small/small, 3 cards per row on medium and up #}
            <div class="card text-white bg-info shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <h5 class="card-title text-center">New Today</h5>
                    <p class="card-text display-4 text-center">{{ dashboard_stats.new_today }}</p>
                </div>
            </div>
        </div>
        {# Resolved Today Card #}
        <div class="col-12 col-md-4 mb-3"> {# Full width on extra small/small, 3 cards per row on medium and up #}
            <div class="card text-white bg-success shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <h5 class="card-title text-center">Resolved Today</h5>
                    <p class="card-text display-4 text-center">{{ dashboard_stats.resolved_today }}</p>
                </div>
            </div>
        </div>
    </div>

    {# New row for the two chart cards #}
    <div class="row mb-4 d-flex"> {# 'd-flex' for equal height chart cards #}
        {# Requests by Status Chart Card #}
        <div class="col-12 col-md-4 mb-3"> {# Full width on extra small/small, 2 charts per row on medium and up #}
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Requests by Status</h5>
                </div>
                <div class="card-body">
                    {# IMPORTANT: Remove fixed width/height from canvas. Chart.js (or your charting library) #}
                    {# should be configured to handle responsiveness. #}
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
        {# Requests by Type Chart Card #}
        <div class="col-12 col-md-4 mb-3"> {# Full width on extra small/small, 2 charts per row on medium and up #}
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Requests by Type</h5>
                </div>
                <div class="card-body">
                    <canvas id="typeChart"></canvas>
                </div>
            </div>
        </div>
        {# Requests by Trends - a Line graph #}
        <div class="col-12 col-md-4 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Requests by Type</h5>
                </div>
                <div class="card-body">
                    <a href="{% url 'support_dashboard:request-trend' %}">Request Trend Page</a>
                </div>
            </div>
        </div>
    </div>

    {# --- Filter and Search Form --- #}
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0">Filter & Search Requests</h5>
        </div>
        <div class="card-body">
            <form method="GET" class="form-row align-items-end">
                <div class="form-group col-md-3">
                    {{ filter_form.q.label_tag }}
                    {{ filter_form.q }}
                </div>
                <div class="form-group col-md-2">
                    {{ filter_form.status.label_tag }}
                    {{ filter_form.status }}
                </div>
                <div class="form-group col-md-2">
                    {{ filter_form.assigned_to.label_tag }}
                    {{ filter_form.assigned_to }}
                </div>
                <div class="form-group col-md-2">
                    {{ filter_form.request_type.label_tag }}
                    {{ filter_form.request_type }}
                </div>
                 <div class="form-group col-md-3">
                    <div class="form-check pt-4">
                        {{ filter_form.show_unassigned }}
                        {{ filter_form.show_unassigned.label_tag }}
                    </div>
                </div>
                <div class="form-group col-md-3">
                    {{ filter_form.submitted_after.label_tag }}
                    {{ filter_form.submitted_after }}
                </div>
                <div class="form-group col-md-3">
                    {{ filter_form.submitted_before.label_tag }}
                    {{ filter_form.submitted_before }}
                </div>
                <div class="form-group col-md-auto ml-auto">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <a href="{% url 'support_dashboard:request_list' %}" class="btn btn-outline-secondary ml-2">Reset Filters</a>
                </div>
            </form>
        </div>
    </div>

    {# --- Request List Table --- #}
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0">All Requests</h5>
        </div>
        <div class="card-body p-0">
            {% if requests %}
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Subject</th>
                            <th>Category/Service Type</th>
                            <th>Status</th>
                            <th>Assigned To</th>
                            <th>Submitted By</th>
                            <th>Submitted At</th>
                            <th>Updated At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in requests %}
                        <tr>
                            <td>{{ req.pk }}</td>
                            <td>
                                <span class="badge badge-info">{{ req.request_type_slug|title|replace:"_, " }}</span>
                            </td>
                            <td>
                                {% if req.subject %}
                                    {{ req.subject|truncatechars:50 }}
                                {% elif req.question %}
                                    {{ req.question|truncatechars:50 }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if req.category %}{{ req.category.name }}
                                {% elif req.service_type %}{{ req.service_type.name }}
                                {% elif req.emergency_type %}{{ req.emergency_type.name }}
                                {% else %}N/A
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge badge-{% if req.status == 'new' %}primary{% elif req.status == 'in_progress' %}warning{% elif req.status == 'resolved' %}success{% elif req.status == 'closed' %}dark{% elif req.status == 'rejected' %}danger{% else %}secondary{% endif %}">{{ req.get_status_display }}</span>
                            </td>
                            <td>
                                {% if req.assigned_to %}
                                    {{ req.assigned_to.get_full_name|default:req.assigned_to.username }}
                                {% else %}
                                    <span class="text-muted">Unassigned</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if req.submitted_by %}
                                    {{ req.submitted_by.get_full_name|default:req.submitted_by.username }}
                                {% else %}
                                    <span class="text-muted">{{ req.full_name|default:'Anonymous' }}</span>
                                {% endif %}
                            </td>
                            <td>{{ req.submitted_at|date:"M d, Y H:i" }}</td>
                            <td>{{ req.updated_at|date:"M d, Y H:i" }}</td>
                            <td>
                                <a href="{% url 'support_dashboard:request_detail' request_type=req.request_type_slug pk=req.pk %}" class="btn btn-sm btn-info">View/Edit</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9">No requests found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %} {# Closing tag for if requests #}
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
{# Include Chart.js Library from your static files #}
<!-- <script src="{% static 'support_dashboard/js/chart.umd.min.js' %}"></script> -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 

{{ dashboard_stats|json_script:"dashboard-stats" }}

<script>        
document.addEventListener('DOMContentLoaded', function() {
    // Retrieve dashboard statistics from Django context
    // This line fetches the content of the hidden script tag.
    const dashboardStats = JSON.parse(document.getElementById('dashboard-stats').textContent);
    console.log(dashboardStats);

    // Helper to get Chart.js ready data
    function getChartData(countsDict, labelsMap) {
        const labels = [];
        const data = [];
        for (const key in countsDict) {
            if (countsDict.hasOwnProperty(key)) {
                labels.push(labelsMap[key] || key.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '));
                data.push(countsDict[key]);
            }
        }
        return { labels, data };
    }

    // --- Requests by Status Pie Chart ---
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
        const statusColors = {
            'new': '#007bff',       // Primary blue
            'in_progress': '#ffc107', // Warning yellow
            'resolved': '#28a745',  // Success green
            'closed': '#343a40',    // Dark grey
            'rejected': '#dc3545',  // Danger red
            // Add more colors if you have other statuses
        };

        const statusLabelsMap = {
            'new': 'New',
            'in_progress': 'In Progress',
            'resolved': 'Resolved',
            'closed': 'Closed',
            'rejected': 'Rejected',
        };

        // Filter out statuses with 0 count for the chart if desired, or show them
        const filteredStatusCounts = {};
        for (const status in dashboardStats.status_counts) {
            if (dashboardStats.status_counts[status] > 0) {
                filteredStatusCounts[status] = dashboardStats.status_counts[status];
            }
        }

        const { labels: statusLabels, data: statusData } = getChartData(filteredStatusCounts, statusLabelsMap);
        const backgroundColorsStatus = statusLabels.map(label => {
            // Find the original key to get the color, e.g., 'New' -> 'new'
            const originalKey = Object.keys(statusLabelsMap).find(key => statusLabelsMap[key] === label);
            return statusColors[originalKey] || '#6c757d'; // Default secondary grey
        });

        new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusData,
                    backgroundColor: backgroundColorsStatus,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    title: {
                        display: false, // Title is in card-header
                    }
                }
            }
        });
    }

    // --- Requests by Type Bar Chart ---
    const typeCtx = document.getElementById('typeChart');
    if (typeCtx) {
        const typeLabelsMap = {
            'complaint': 'Complaint',
            'service': 'Service Request',
            'inquiry': 'Inquiry',
            'emergency': 'Emergency Report',
        };

        const { labels: typeLabels, data: typeData } = getChartData(dashboardStats.type_counts, typeLabelsMap);
        const backgroundColorsType = [
            'rgba(255, 99, 132, 0.7)', // Red
            'rgba(54, 162, 235, 0.7)', // Blue
            'rgba(255, 206, 86, 0.7)', // Yellow
            'rgba(75, 192, 192, 0.7)', // Green
            'rgba(153, 102, 255, 0.7)',// Purple
        ];

        new Chart(typeCtx, {
            type: 'bar',
            data: {
                labels: typeLabels,
                datasets: [{
                    label: 'Number of Requests',
                    data: typeData,
                    backgroundColor: backgroundColorsType.slice(0, typeLabels.length),
                    borderColor: backgroundColorsType.map(color => color.replace('0.7', '1')), // Darker border
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false, // Not needed for single dataset bar chart
                    },
                    title: {
                        display: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) { if (Number.isInteger(value)) { return value; } }
                        }
                    }
                }
            }
        });
    }
    
});
</script>
{% endblock %}