{# support_dashboard/templates/support_dashboard/request_list.html #}
{% extends 'support_dashboard/base.html' %}
{% load static %}
{% load dashboard_extras %} {# Keep this if you want the instance_of filter elsewhere #}

{% block title %}All Requests - Support Dashboard{% endblock %}

{% block content %}
<h2 class="mb-4">All Requests</h2>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Subject</th>
                <th>Category/Service Type</th>
                <th>Status</th>
                <th>Assigned To</th>
                <th>Submitted By</th>
                <th>Submitted At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for req in requests %}
            <tr>
                <td>{{ req.pk }}</td>
                <td>
                    {# Use the new request_type_slug for display #}
                    {{ req.request_type_slug|title }}
                </td>
                <td>{{ req.subject }}</td>
                <td>
                    {% if req.category %}{{ req.category.name }}
                    {% elif req.service_type %}{{ req.service_type.name }}
                    {% elif req.inquiry_category %}{{ req.inquiry_category.name }}
                    {% elif req.emergency_type %}{{ req.emergency_type.name }}
                    {% else %}N/A
                    {% endif %}
                </td>
                <td><span class="badge badge-{% if req.status == 'new' %}primary{% elif req.status == 'in_progress' %}info{% elif req.status == 'resolved' %}success{% elif req.status == 'closed' %}secondary{% elif req.status == 'rejected' %}danger{% endif %}">{{ req.get_status_display }}</span></td>
                <td>
                    {# Check if assigned_to exists before accessing its attributes #}
                    {% if req.assigned_to %}
                        {{ req.assigned_to.get_full_name|default:req.assigned_to.username }}
                    {% else %}
                        Unassigned
                    {% endif %}
                </td>
                <td>
                    {# Check if submitted_by exists before accessing its attributes #}
                    {% if req.submitted_by %}
                        {{ req.submitted_by.get_full_name|default:req.submitted_by.username }}
                    {% else %}
                        Anonymous {# Or you can use req.full_name if that's where anonymous name is stored #}
                    {% endif %}
                </td>
                <td>{{ req.submitted_at|date:"M d, Y H:i" }}</td>
                <td>
                    <a href="{% url 'support_dashboard:request_detail' request_type=req.request_type_slug pk=req.pk %}" class="btn btn-sm btn-info">View/Edit</a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9">No requests found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Custom template tag (instance_of) alternative for checking class type in template
    // This can be done in Django template filters for cleaner code,
    // but for a quick setup, direct comparison here works if you add a simple custom tag.
    // For production, consider creating a custom template filter.
</script>
{% endblock %}